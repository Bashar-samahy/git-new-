name: Node.js CI Pipeline

# ============================================
# Ø§Ù„Ù‚Ø³Ù… 1: Triggers (Ø§Ù„Ù…Ø´ØºÙ„Ø§Øª)
# ============================================
on:
  # 1. Ø­Ø¯Ø« Push
  push:
    # âš¡ ÙŠØ´ØªØºÙ„ Ø¹Ù„Ù‰ push Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù€ branches
    branches:
      - main           # Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
      - 'release/**'   # Ø£ÙŠ ÙØ±Ø¹ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ release/
      # Ù…Ø«Ø§Ù„: release/v1.0, release/v2.0-beta
    
    # âš¡ ÙŠØ´ØªØºÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø³Ø§Ø±Ø§Øª
    paths:
      - 'src/**'      # Ø£ÙŠ Ù…Ù„Ù Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ src
      # âš¡ Ù„Ù…Ø§Ø°Ø§ src ÙÙ‚Ø·ØŸ
      # 1. ÙƒÙØ§Ø¡Ø©: Ù…Ø§ ØªØ¨Ø¯Ø£Ø´ workflow Ø¥Ø°Ø§ Ø§Ù„ØªØºÙŠÙŠØ± ÙÙŠ docs Ù…Ø«Ù„Ø§Ù‹
      # 2. ØªØ±ÙƒÙŠØ²: ÙŠÙ‡ØªÙ… ÙÙ‚Ø· Ø¨Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯
      # 3. ØªÙˆÙÙŠØ±: Ù…Ø§ ØªØ¶ÙŠØ¹Ø´ ÙˆÙ‚Øª Ø§Ù„Ù€ runner
  
  # 2. Ø­Ø¯Ø« Pull Request
  pull_request:
    # âš¡ ÙŠØ´ØªØºÙ„ Ø¹Ù„Ù‰ PRs Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù€ branches
    branches:
      - main
      - 'release/**'
    # âš¡ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Ø§ÙØªØ±Ø§Ø¶ÙŠ: opened, synchronize, reopened)
    # synchronize: Ù„Ù…Ø§ ØªØ¶ÙŠÙ commits Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ù€ PR

# ============================================
# Ø§Ù„Ù‚Ø³Ù… 2: Jobs (Ø§Ù„Ù…Ù‡Ø§Ù…)
# ============================================
jobs:
  # Ø§Ù„Ù…Ù‡Ù…Ø© 1: Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
  test:
    # âš¡ Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© ÙŠØ¸Ù‡Ø± ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© GitHub
    name: Run Tests on Ubuntu
    
    # âš¡ Ù†ÙˆØ¹ Runner (Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù„ÙŠ Ù‡ÙŠØ´ØºÙ„ Ø§Ù„ÙƒÙˆØ¯)
    runs-on: ubuntu-latest
    # âš¡ ubuntu-latest = Ø£Ø­Ø¯Ø« Ù†Ø³Ø®Ø© Ø£ÙˆØ¨Ù†ØªÙˆ
    # âš¡ Ù…Ø¬Ø§Ù†ÙŠ Ù„Ù„Ù€ public repos
    
    # ============================================
    # Ø§Ù„Ù‚Ø³Ù… 3: Ø§Ù„Ø®Ø·ÙˆØ§Øª (Steps)
    # ============================================
    steps:
      # --------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 1: ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Repository
      # --------------------------------------------------
      - name: Checkout code
        # âš¡ "name": Ø§Ø³Ù… ÙŠØ¸Ù‡Ø± ÙÙŠ logs
        uses: actions/checkout@v4.2.2
        # âš¡ "uses": ØªØ³ØªØ®Ø¯Ù… Action Ø¬Ø§Ù‡Ø²
        # âš¡ actions/checkout: ÙŠÙ†Ø²Ù„ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ù€ repo
        # âš¡ @v4.2.2: Ø¥ØµØ¯Ø§Ø± Ù…Ø­Ø¯Ø¯ Ù„Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø±
        
      # --------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¥Ø¹Ø¯Ø§Ø¯ Node.js
      # --------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          # âš¡ "with": ØªÙ…Ø±ÙŠØ± parameters Ù„Ù„Ù€ Action
          node-version: '20'  # Ø¥ØµØ¯Ø§Ø± Node.js
          # âš¡ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… 'lts/*' Ù„Ø£Ø­Ø¯Ø« Ø¥ØµØ¯Ø§Ø± LTS
          cache: 'npm'  # ÙŠØ®Ø²Ù† node_modules Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
          
      # --------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 3: ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª
      # --------------------------------------------------
      - name: Install dependencies
        run: npm ci
        # âš¡ "run": ØªØ´ØºÙ„ Ø£Ù…Ø± ÙÙŠ shell
        # âš¡ npm ci Ø£ÙØ¶Ù„ Ù…Ù† npm install Ù„Ù„Ù€ CI:
        # 1. Ø£Ø³Ø±Ø¹
        # 2. Ø£ÙƒØ«Ø± Ø¯Ù‚Ø© (Ø¨Ø³ØªØ®Ø¯Ù… package-lock.json Ø¨Ø§Ù„Ø¶Ø¨Ø·)
        # 3. Ø£Ù†Ø¸Ù (Ø¨ÙŠØ­Ø°Ù node_modules Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ Ù„Ø²Ù…)
        
      # --------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 4: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨Ù†ÙŠØ© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
      # --------------------------------------------------
      - name: Verify project structure
        run: |
          echo "ğŸ“ Project structure:"
          ls -la
          echo -e "\nğŸ“ src directory:"
          ls -la src/
          echo -e "\nğŸ“„ app.js content (first 10 lines):"
          head -10 src/app.js
        # âš¡ | (pipe): ÙŠØ¹Ù†ÙŠ Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ§Ù„ÙŠØ© ÙƒÙ„Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† run ÙˆØ§Ø­Ø¯
        
      # --------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 5: ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
      # --------------------------------------------------
      - name: Run the application
        run: |
          echo "ğŸš€ Testing direct execution..."
          OUTPUT=$(node src/app.js)
          echo "Application output:"
          echo "$OUTPUT"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø§ØªØ¬ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹
          if echo "$OUTPUT" | grep -q "Hello, World!"; then
            echo "âœ… Application output is correct!"
          else
            echo "âŒ Expected output not found!"
            exit 1
          fi
          
      # --------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 6: Ø§Ø®ØªØ¨Ø§Ø± module exports
      # --------------------------------------------------
      - name: Test module exports
        run: |
          echo "ğŸ”§ Testing module exports..."
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¤Ù‚Øª
          cat > test_module.js << 'EOF'
          const app = require('./src/app.js');
          
          console.log("Testing greet function:");
          const greetResult = app.greet("GitHub");
          console.log(greetResult);
          
          console.log("\nTesting add function:");
          const addResult = app.add(10, 20);
          console.log("10 + 20 =", addResult);
          
          console.log("\nTesting isEven function:");
          console.log("Is 8 even?", app.isEven(8));
          console.log("Is 9 even?", app.isEven(9));
          
          console.log("\nâœ… All module tests passed!");
          EOF
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
          node test_module.js
          
          # ØªÙ†Ø¸ÙŠÙ
          rm -f test_module.js
          
      # --------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 7: ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª (test.sh)
      # --------------------------------------------------
      - name: Run test suite
        run: |
          echo "ğŸ§ª Running test suite..."
          
          # Ø¬Ø¹Ù„ Ø§Ù„Ù…Ù„Ù Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙ†ÙÙŠØ° (Ø¥Ø°Ø§ Ù„Ø²Ù…)
          chmod +x src/test.sh
          
          # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
          ./src/test.sh
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
          TEST_EXIT_CODE=$?
          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "âœ… All tests passed!"
          else
            echo "âŒ Tests failed with exit code: $TEST_EXIT_CODE"
            exit $TEST_EXIT_CODE
          fi
          
      # --------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 8: Ø§Ø®ØªØ¨Ø§Ø± npm scripts
      # --------------------------------------------------
      - name: Test npm scripts
        run: |
          echo "ğŸ“¦ Testing npm scripts..."
          
          echo -e "\n1. Testing 'npm start':"
          npm start 2>&1 | head -10
          
          echo -e "\n2. Testing 'npm test':"
          npm test 2>&1 | tail -5
          
      # --------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 9: Ø¥Ø¸Ù‡Ø§Ø± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
      # --------------------------------------------------
      - name: System information
        if: success()  # âš¡ ØªØªÙ†ÙØ° ÙÙ‚Ø· Ù„Ùˆ ÙƒÙ„ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ù†Ø¬Ø­Øª
        run: |
          echo "ğŸ’» System Info:"
          echo "Node.js: $(node --version)"
          echo "npm: $(npm --version)"
          echo "OS: $(uname -s) $(uname -r)"
          echo "CPU: $(nproc) cores"
          echo "Memory:"
          free -h
          
      # --------------------------------------------------
      # Ø§Ù„Ø®Ø·ÙˆØ© 10: Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
      # --------------------------------------------------
      - name: Completion message
        if: always()  # âš¡ ØªØªÙ†ÙØ° Ø¯Ø§Ø¦Ù…Ù‹Ø§ (Ù†Ø¬Ø§Ø­ Ø£Ùˆ ÙØ´Ù„)
        run: |
          echo "========================================"
          echo "ğŸ“Š Workflow Result: ${{ job.status }}"
          echo "ğŸ•’ Finished at: $(date)"
          echo "ğŸ’¾ Runner: ubuntu-latest"
          echo "ğŸ¯ Event: ${{ github.event_name }}"
          echo "ğŸ”— Branch: ${{ github.ref }}"
          echo "ğŸ‘¤ Triggered by: ${{ github.actor }}"
          echo "========================================"